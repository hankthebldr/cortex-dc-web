# Settings for Backend (on Cloud Run).
# See https://firebase.google.com/docs/app-hosting/configure#cloud-run
runConfig:
  # Keep at least one instance warm to avoid cold starts while respecting staging rollouts.
  minInstances: 1
  # Allow the service to burst during peak traffic while staying within budget.
  maxInstances: 20
  # Tune concurrency to balance throughput and latency for the Next.js edge handler.
  concurrency: 40
  # Allocate additional CPU to sustain Lighthouse and Playwright budgets under load.
  cpu: 2
  # Increase memory to accommodate SSR rendering and caching.
  memoryMiB: 2048

# Environment variables and secrets.
env:
  # Expose the deployment environment to both build-time and runtime processes.
  - variable: NEXT_PUBLIC_APP_ENV
    value: production
    availability:
      - BUILD
      - RUNTIME

  # Provide the backend API endpoint at runtime without leaking credentials during the build.
  - variable: API_BASE_URL
    secret: projects/${PROJECT_ID}/secrets/API_BASE_URL/versions/latest
    availability:
      - RUNTIME

  # Align the Node.js logger with production defaults.
  - variable: LOG_LEVEL
    value: info
    availability:
      - RUNTIME

  # Used by Cloud Functions to report the active deployment environment.
  - variable: APP_ENV
    value: production
    availability:
      - RUNTIME

  # Configurable message surfaced via the environmentSummary HTTPS function.
  - variable: PUBLIC_HELLO_MESSAGE
    value: Welcome to the Cortex Data Connect portal
    availability:
      - RUNTIME

  # Build metadata injected into the runtime for observability.
  - variable: APP_VERSION
    value: "v1.0.0"
    availability:
      - RUNTIME

  # Grant access to secrets in Cloud Secret Manager at runtime.
  - variable: SERVICE_WEBHOOK_SECRET
    secret: projects/cortex-dc-portal/secrets/service-webhook-secret/versions/latest
    availability:
      - RUNTIME
